#!/bin/bash

rm /root/foo.txt

cat <<EOF > help.txt
# Your Quest
-------------------------------

By modifying python/challeng.py, node/challenge.js, go/challenge.go, or using gsutil
directly, download the image we've hidden in \$BUCKET_NAME. Using print-png,
view the image, and type "answer" when you're ready to tell us what it is.

Feeling stuck? run gsutil --help, or cat help.txt.

Hit the "Check" button when you are done.

Coding Your Solution
-------------------------------

If you run 'ls', you will see folders for each supported language; currently
python, node (JavaScript), and go.

Use 'cd' to enter one of these folders. There will be a file with the name
'code-sample' and a file with the name 'challenge' (with an extension
corresponding to the language you're using).

If you need help getting started, use 'cat' to display the code sample.

Once you're ready to write some code, use vim, nano, or emacs to edit the
challenge file.

Before clicking the "Check" button, run your application with node, go, or
Python.

# Using gsutil
-------------------------------

You will also find the gsutil utility installed, and the environment variable
\$BUCKET_NAME set. Run "gsutil --help" for information about this command.
EOF


cat <<EOF > node/challenge.js
// Imports the Google Cloud client library
const {Storage} = require('@google-cloud/storage')

// Globally unique bucket name (don't change this).
const bucketName = process.env.BUCKET_NAME

// An authenticated storage API client.
const storage = new Storage()

async function downloadImage () {
  // put your code here for downloading the .png image stored in
  // bucketName.
  const [files] = await storage.bucket(bucketName).getFiles();

  files.forEach(file => {
    console.info(file.name)
  });
}

downloadImage()
EOF

cat <<EOF > node/code-sample.js
// Imports the Google Cloud client library
const {Storage} = require('@google-cloud/storage');

// Creates a client
const storage = new Storage();

/**
 * TODO(developer): Uncomment the following lines before running the sample.
 */
// const bucketName = 'Name of a bucket, e.g. my-bucket';
// const srcFilename = 'Remote file to download, e.g. file.txt';
// const destFilename = 'Local destination for file, e.g. ./local/path/to/file.txt';

const options = {
  // The path to which the file should be downloaded, e.g. "./file.txt"
  destination: destFilename,
};

// Downloads the file
await storage
  .bucket(bucketName)
  .file(srcFilename)
  .download(options);

console.log(
  \`gs://${bucketName}/${srcFilename} downloaded to ${destFilename}.\`
);
EOF

cat <<EOF > /usr/local/lib/google-cloud-sdk/bin/check-answer.js
const {readFileSync} = require('fs')
const lines = readFileSync('/root/.quiz/answer.txt', 'utf8').trim().split('\n')
const lastLine = lines[lines.length - 1].toLowerCase()
if (lastLine !== 'dog') {
    console.error('incorrect answer')
    process.exit(1)
}
EOF

mkdir /root/python

cat <<EOF > python/challenge.py
import os
from google.cloud import storage

"""The bucket has already been created and an additional file has 
   been uploaded.  Download and view the .png file"""

def download_blob():
    storage_client = storage.Client()
    bucket = storage_client.get_bucket(os.environ['BUCKET_NAME'])

    blobs = bucket.list_blobs()

    for blob in blobs:
        print(blob.name)
        # Add code to download the .png file
        if blob.name[-3:] == 'png':
           print('Blob {} downloaded'.format(blob.name))

if __name__ == '__main__':
    download_blob()

EOF

cat <<EOF > python/code-sample.py
def download_blob(bucket_name, source_blog_name, destination_file_name):
    """Downloads an object from the bucket"""
    storage_client = storage.Client()
    bucket = storage_client.get_bucket(bucket_name)
    blob = bucket.blob(source_blob_name)

    blob.download_to_filename(destination_file_name)

    print('Blob {} downloaded to {}'.format(source_blob_name, destination_file_name)
EOF

# go code samples and stubbed out challenge.
cat <<EOF > go/challenge.go
package main

import (
	"cloud.google.com/go/storage"
	"context"
	"google.golang.org/api/iterator"
	"io/ioutil"
	"log"
	"os"
	"strings"
)

func main() {
	ctx := context.Background()

	// [START setup]
	client, err := storage.NewClient(ctx)
	if err != nil {
		log.Fatal(err)
	}
	// [END setup]

	// Give the bucket a unique name.
	bucketName := os.Getenv("BUCKET_NAME")
	if err := download(client, bucketName); err != nil {
		log.Fatalf("Cannot write object: %v", err)
	}
}

func download(client *storage.Client, bucketName) error {
	ctx := context.Background()
	it := client.Bucket(bucketName).Objects(ctx, nil)
	for {
		oattrs, err := it.Next()
		if err == iterator.Done {
			break
		}
		if err != nil {
			return err
		}

		if strings.Index(oattrs.Name, "png") != -1 {
			//
			// logic for writing file to disk.
			//
		}
	}

	return nil
}
EOF

cat <<EOF > go/code-sample.go
// [START download_file]
rc, err := client.Bucket(bucketName).Object(oattrs.Name).NewReader(ctx)
if err != nil {
  return err
}
defer rc.Close()

data, err := ioutil.ReadAll(rc)
if err != nil {
  return err
}

err := ioutil.WriteFile("challenge.png", data, 0644)
if err != nil {
  return err
}
// [END download_file]
EOF
